---
import { cn } from '../../utils/merge';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class={cn('w-full max-w-md mx-auto', className)} id="waitlist-form-wrapper">
  <div class="mb-3 flex justify-center">
    <span class="inline-flex items-center gap-1.5 rounded-full bg-coral/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.15em] text-coral">
      <span class="h-1.5 w-1.5 rounded-full bg-coral animate-pulse" aria-hidden="true"></span>
      Limited beta â€” 50 spots per week
    </span>
  </div>

  <form id="waitlist-form" class="flex flex-col gap-3">
    <div class="flex flex-col gap-3 sm:flex-row">
      <input
        type="text"
        name="name"
        placeholder="Your name"
        required
        autocomplete="name"
        class="flex-1 rounded-xl border-2 border-dark/10 bg-paper px-4 py-3 text-sm text-dark placeholder:text-dark/30 outline-none transition-colors focus:border-coral/50"
      />
      <input
        type="email"
        name="email"
        placeholder="you@example.com"
        required
        autocomplete="email"
        class="flex-1 rounded-xl border-2 border-dark/10 bg-paper px-4 py-3 text-sm text-dark placeholder:text-dark/30 outline-none transition-colors focus:border-coral/50"
      />
    </div>
    <button
      type="submit"
      class="flex items-center justify-center gap-2 rounded-xl bg-dark px-6 py-3.5 text-[0.9rem] text-paper shadow-lg transition-all duration-200 ease-out hover:scale-[1.02] hover:shadow-xl hover:bg-dark/90 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
    >
      <span id="waitlist-btn-text">Join the waitlist</span>
      <svg id="waitlist-spinner" class="hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" class="opacity-25" />
        <path d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="3" stroke-linecap="round" class="opacity-75" />
      </svg>
    </button>
  </form>

  <p id="waitlist-message" class="mt-3 text-center text-sm hidden" role="status" aria-live="polite"></p>
</div>

<script is:inline>
  (function() {
    function initWaitlistForm() {
      const form = document.getElementById('waitlist-form');
      if (!form || form.dataset.initialized) return;
      form.dataset.initialized = 'true';

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        const btnText = document.getElementById('waitlist-btn-text');
        const spinner = document.getElementById('waitlist-spinner');
        const msg = document.getElementById('waitlist-message');

        const name = form.querySelector('input[name="name"]').value.trim();
        const email = form.querySelector('input[name="email"]').value.trim();

        btn.disabled = true;
        btnText.textContent = 'Submitting...';
        spinner.classList.remove('hidden');
        msg.classList.add('hidden');

        try {
          const res = await fetch('/api/waitlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, name: name }),
          });
          const data = await res.json();

          if (res.ok) {
            msg.textContent = "You're on the list! We'll be in touch soon.";
            msg.className = 'mt-3 text-center text-sm text-coral font-semibold';
            form.reset();
          } else {
            msg.textContent = data.error || 'Something went wrong. Please try again.';
            msg.className = 'mt-3 text-center text-sm text-coral/80';
          }
        } catch {
          msg.textContent = 'Network error. Please try again.';
          msg.className = 'mt-3 text-center text-sm text-coral/80';
        } finally {
          btn.disabled = false;
          btnText.textContent = 'Join the waitlist';
          spinner.classList.add('hidden');
        }
      });
    }
    initWaitlistForm();
    document.addEventListener('astro:after-swap', initWaitlistForm);
  })();
</script>
