---
import { cn } from '../../utils/merge';

interface Props {
  class?: string;
}

const { class: className } = Astro.props;

const features = [
  {
    title: 'Deep Research',
    description: 'Analyze hundreds of sources in minutes. Get structured, cited reports on any topic.',
  },
  {
    title: 'Full-Stack Builder',
    description: 'Describe your app and Midsphere builds it — frontend, backend, database, deployment.',
  },
  {
    title: 'Workflow Automation',
    description: 'Connect your tools and automate repetitive work across platforms, triggered by natural language.',
  },
  {
    title: 'Smart Integrations',
    description: '500+ platforms connected via OAuth. Slack, GitHub, Google Sheets, Notion, and more.',
  },
  {
    title: 'Sandboxed Execution',
    description: 'Every task runs in an isolated cloud environment. Your data stays safe, your code runs clean.',
  },
] as const;

const panelArt = [
  '/images/art/research.jpg',
  '/images/art/builder.jpg',
  '/images/art/workflow.jpg',
  '/images/art/integrations.jpg',
  '/images/art/sandbox.jpg',
] as const;
---

<section id="features" class={cn('section-divider py-12 lg:py-24', className)} aria-labelledby="features-heading">
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
    <!-- Left-aligned header like Zen -->
    <div class="mb-12 lg:mb-16" data-animate>
      <h2 id="features-heading" class="text-3xl font-semibold leading-[0.95] tracking-tight sm:text-4xl lg:text-5xl">What can Midsphere do?</h2>
      <p class="mt-5 max-w-2xl text-base text-dark/60 sm:text-lg">Everything you need to research, build, and automate — powered by AI.</p>
    </div>

    <!-- Mobile: horizontal scroll tabs -->
    <div class="flex gap-2 overflow-x-auto pb-4 lg:hidden" role="tablist" aria-label="Feature tabs">
      {features.map((feature, i) => (
        <button
          type="button"
          role="tab"
          class={cn(
            'feature-tab shrink-0 rounded-lg px-4 py-2 text-sm font-medium transition-colors whitespace-nowrap',
            i === 0 ? 'bg-subtle text-dark' : 'text-dark/50 hover:text-dark hover:bg-subtle/50',
          )}
          data-feature-index={i}
          data-active={i === 0 ? 'true' : 'false'}
          aria-selected={i === 0 ? 'true' : 'false'}
          aria-controls={`feature-panel-${i}`}
        >
          {feature.title}
        </button>
      ))}
    </div>

    <!-- Two-column layout -->
    <div class="flex flex-col gap-8 lg:flex-row lg:items-start lg:gap-12">
      <!-- Left: Desktop clickable feature list -->
      <div class="hidden lg:flex lg:w-1/3 lg:flex-col lg:gap-1" role="tablist" aria-label="Feature tabs">
        {features.map((feature, i) => (
          <button
            type="button"
            role="tab"
            class={cn(
              'feature-item rounded-lg p-4 text-left transition-all duration-200',
              i === 0 ? 'bg-subtle' : 'opacity-50 hover:opacity-80 hover:bg-subtle/50',
            )}
            data-feature-index={i}
            data-active={i === 0 ? 'true' : 'false'}
            aria-selected={i === 0 ? 'true' : 'false'}
            aria-controls={`feature-panel-${i}`}
          >
            <h3 class="text-lg font-bold">{feature.title}</h3>
            <p class="mt-1 text-sm text-dark/60">{feature.description}</p>
          </button>
        ))}
      </div>

      <!-- Right: visual showcase panels (sticky on desktop) -->
      <div class="relative lg:w-3/5 lg:sticky lg:top-24 lg:self-start">
        <div class="relative aspect-video w-full">
          {features.map((feature, i) => (
            <div
              id={`feature-panel-${i}`}
              role="tabpanel"
              class={cn(
                'feature-panel absolute inset-0 rounded-2xl overflow-hidden transition-opacity duration-300',
                i === 0 ? 'opacity-100' : 'opacity-0 pointer-events-none',
              )}
              data-feature-index={i}
              data-active={i === 0 ? 'true' : 'false'}
            >
              {/* Background painting */}
              <img src={panelArt[i]} class="absolute inset-0 w-full h-full object-cover" alt="" aria-hidden="true" loading="lazy" />
              <div class="absolute inset-0 bg-dark/20"></div>

              {/* App mockup floating over painting */}
              <div class="relative flex items-center justify-center h-full p-3 sm:p-5 lg:p-7">
                <div class="w-full h-full rounded-xl bg-dark/95 backdrop-blur-sm text-paper shadow-xl overflow-hidden border border-paper/10 flex flex-col">
                <!-- Window chrome -->
                <div class="flex items-center gap-2 border-b border-paper/10 px-4 py-2.5">
                  <div class="flex gap-1.5">
                    <div class="h-2.5 w-2.5 rounded-full bg-paper/20"></div>
                    <div class="h-2.5 w-2.5 rounded-full bg-paper/20"></div>
                    <div class="h-2.5 w-2.5 rounded-full bg-paper/20"></div>
                  </div>
                  <span class="ml-2 text-xs text-paper/30">{feature.title}</span>
                </div>
                <!-- App body -->
                <div class="flex flex-1 overflow-hidden">
                  {/* Sidebar nav */}
                  <div class="hidden sm:flex w-10 shrink-0 flex-col items-center gap-2.5 border-r border-paper/10 py-3 bg-paper/[0.03]">
                    <div class={`w-6 h-6 rounded-md flex items-center justify-center ${i === 0 ? 'bg-coral/80' : 'bg-paper/10 text-paper/40'}`} aria-hidden="true">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                    <div class={`w-6 h-6 rounded-md flex items-center justify-center ${i === 1 ? 'bg-coral/80' : 'bg-paper/10 text-paper/40'}`} aria-hidden="true">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                    </div>
                    <div class={`w-6 h-6 rounded-md flex items-center justify-center ${i === 2 ? 'bg-coral/80' : 'bg-paper/10 text-paper/40'}`} aria-hidden="true">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/><path d="m21 16-4 4-4-4"/><path d="M17 20V4"/></svg>
                    </div>
                    <div class={`w-6 h-6 rounded-md flex items-center justify-center ${i === 3 ? 'bg-coral/80' : 'bg-paper/10 text-paper/40'}`} aria-hidden="true">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
                    </div>
                    <div class={`w-6 h-6 rounded-md flex items-center justify-center ${i === 4 ? 'bg-coral/80' : 'bg-paper/10 text-paper/40'}`} aria-hidden="true">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg>
                    </div>
                  </div>

                  {/* Main content area */}
                  <div class="flex-1 min-w-0">
                    {/* Panel 0: Deep Research */}
                    {i === 0 && (
                      <div class="flex h-full">
                        <div class="hidden sm:flex w-36 shrink-0 flex-col border-r border-paper/10 bg-paper/[0.02]">
                          <div class="px-3 py-2 text-[10px] font-medium uppercase tracking-wider text-paper/30">Sources</div>
                          {['TechCrunch', 'arXiv Paper', 'Gartner Report', 'Bloomberg', 'MIT Tech Review', 'CB Insights', 'McKinsey'].map((src, j) => (
                            <div class={`flex items-center gap-1.5 px-3 py-1.5 text-[11px] ${j === 0 ? 'bg-paper/[0.06] text-paper/80' : 'text-paper/40'}`}>
                              <div class={`h-1.5 w-1.5 rounded-full shrink-0 ${j < 5 ? 'bg-zen-green' : 'bg-paper/20'}`}></div>
                              <span class="truncate">{src}</span>
                            </div>
                          ))}
                          <div class="mt-auto px-3 py-2 text-[10px] text-paper/30">247 sources total</div>
                        </div>
                        <div class="flex-1 flex flex-col gap-3 p-4 sm:p-5">
                          <div class="text-[10px] font-medium uppercase tracking-wider text-paper/30">Research Report</div>
                          <div class="text-sm font-semibold text-paper/90 sm:text-base">Market Analysis: AI Agents 2025</div>
                          <div class="flex gap-3 text-[10px]">
                            <div class="flex flex-col items-center rounded-lg bg-paper/[0.06] px-3 py-2">
                              <span class="text-base font-bold text-coral">$4.8B</span>
                              <span class="text-paper/40">Market Size</span>
                            </div>
                            <div class="flex flex-col items-center rounded-lg bg-paper/[0.06] px-3 py-2">
                              <span class="text-base font-bold text-zen-green">34%</span>
                              <span class="text-paper/40">YoY Growth</span>
                            </div>
                            <div class="flex flex-col items-center rounded-lg bg-paper/[0.06] px-3 py-2">
                              <span class="text-base font-bold text-zen-blue">12</span>
                              <span class="text-paper/40">Key Players</span>
                            </div>
                          </div>
                          <div class="flex flex-col gap-1.5 text-[11px] text-paper/50">
                            <div class="flex items-start gap-2"><span class="text-zen-green mt-0.5 shrink-0">&#10003;</span><span>Agent-based architectures outperform traditional automation by 3.2x</span></div>
                            <div class="flex items-start gap-2"><span class="text-zen-green mt-0.5 shrink-0">&#10003;</span><span>Enterprise adoption accelerating — 68% of Fortune 500 piloting</span></div>
                            <div class="flex items-start gap-2"><span class="text-zen-green mt-0.5 shrink-0">&#10003;</span><span>Code generation and research are top use-cases</span></div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Panel 1: Full-Stack Builder */}
                    {i === 1 && (
                      <div class="flex h-full">
                        <div class="hidden sm:flex w-32 shrink-0 flex-col border-r border-paper/10 bg-paper/[0.02]">
                          <div class="px-3 py-2 text-[10px] font-medium uppercase tracking-wider text-paper/30">Explorer</div>
                          <div class="flex flex-col text-[11px] text-paper/50">
                            <div class="flex items-center gap-1.5 bg-paper/[0.06] px-3 py-1 text-paper/80">
                              <span class="text-zen-blue">&#9662;</span> app/
                            </div>
                            <div class="flex items-center gap-1.5 px-6 py-1 text-coral">page.tsx</div>
                            <div class="flex items-center gap-1.5 px-6 py-1">layout.tsx</div>
                            <div class="flex items-center gap-1.5 px-3 py-1">
                              <span class="text-zen-blue">&#9656;</span> lib/
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1">
                              <span class="text-zen-blue">&#9656;</span> prisma/
                            </div>
                            <div class="flex items-center gap-1.5 px-3 py-1">.env</div>
                            <div class="flex items-center gap-1.5 px-3 py-1">package.json</div>
                          </div>
                        </div>
                        <div class="flex-1 flex flex-col min-w-0">
                          <div class="flex items-center gap-2 border-b border-paper/10 px-3 py-1.5">
                            <span class="rounded bg-paper/10 px-2 py-0.5 text-[10px] text-coral">page.tsx</span>
                            <span class="rounded px-2 py-0.5 text-[10px] text-paper/30">layout.tsx</span>
                          </div>
                          <div class="flex-1 p-3 font-mono text-[11px] leading-relaxed text-paper/60 overflow-hidden">
                            <div><span class="text-zen-blue">export default</span> <span class="text-paper/80">function</span> <span class="text-zen-green">Dashboard</span>() {'{'}</div>
                            <div class="pl-4"><span class="text-zen-blue">const</span> {'{'} user {'}'} = <span class="text-coral">useAuth</span>();</div>
                            <div class="pl-4"><span class="text-zen-blue">const</span> {'{'} data {'}'} = <span class="text-coral">useQuery</span>(stats);</div>
                            <div class="pl-4"><span class="text-zen-blue">return</span> (</div>
                            <div class="pl-8">&lt;<span class="text-coral">StatsGrid</span> data={'{data}'} /&gt;</div>
                            <div class="pl-4">);</div>
                            <div>{'}'}</div>
                          </div>
                          <div class="border-t border-paper/10 bg-paper/[0.02] px-3 py-2 font-mono text-[10px]">
                            <div class="flex items-center gap-2 text-paper/40">
                              <span class="text-zen-green">&#10003;</span><span>Built</span>
                              <span class="text-zen-green">&#10003;</span><span>Tested</span>
                              <span class="text-coral animate-pulse">&#9679;</span><span class="text-paper/60">Deploying...</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Panel 2: Workflow Automation */}
                    {i === 2 && (
                      <div class="flex h-full flex-col p-4 sm:p-5 gap-4">
                        <div class="flex items-center justify-between">
                          <div class="text-[10px] font-medium uppercase tracking-wider text-paper/30">Workflow Builder</div>
                          <div class="flex items-center gap-1.5 rounded-full bg-zen-green/20 px-2 py-0.5 text-[10px] text-zen-green">
                            <div class="h-1.5 w-1.5 rounded-full bg-zen-green"></div>
                            3 active
                          </div>
                        </div>
                        <div class="flex flex-col gap-3">
                          {[
                            { trigger: 'New PR opened', process: 'Code review', action: 'Post to Slack' },
                            { trigger: 'Invoice received', process: 'Extract data', action: 'Google Sheets' },
                            { trigger: 'Daily 9am', process: 'Summarize standup', action: 'Email digest' },
                          ].map((flow) => (
                            <div class="flex items-center gap-2 text-[11px]">
                              <div class="flex items-center gap-1.5 rounded-lg bg-zen-blue/10 border border-zen-blue/20 px-2.5 py-1.5 text-paper/70 shrink-0">
                                <div class="h-1.5 w-1.5 rounded-full bg-zen-blue"></div>
                                <span class="hidden sm:inline">{flow.trigger}</span>
                                <span class="sm:hidden truncate max-w-[60px]">{flow.trigger}</span>
                              </div>
                              <div class="text-paper/20 shrink-0">→</div>
                              <div class="flex items-center gap-1.5 rounded-lg bg-paper/[0.06] border border-paper/10 px-2.5 py-1.5 text-paper/60 shrink-0">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-paper/30"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 7v5l3 3"/></svg>
                                <span class="hidden sm:inline">{flow.process}</span>
                                <span class="sm:hidden truncate max-w-[50px]">{flow.process}</span>
                              </div>
                              <div class="text-paper/20 shrink-0">→</div>
                              <div class="flex items-center gap-1.5 rounded-lg bg-zen-green/10 border border-zen-green/20 px-2.5 py-1.5 text-paper/70 shrink-0">
                                <span class="text-zen-green">&#10003;</span>
                                <span class="hidden sm:inline">{flow.action}</span>
                                <span class="sm:hidden truncate max-w-[50px]">{flow.action}</span>
                              </div>
                            </div>
                          ))}
                        </div>
                        <div class="mt-auto flex items-center gap-4 text-[10px] text-paper/30">
                          <span>1,247 runs this week</span>
                          <span>Avg 2.3s per run</span>
                          <span class="text-zen-green">100% success rate</span>
                        </div>
                      </div>
                    )}

                    {/* Panel 3: Smart Integrations */}
                    {i === 3 && (
                      <div class="flex h-full flex-col p-4 sm:p-5 gap-3">
                        <div class="flex items-center gap-2 rounded-lg bg-paper/[0.06] px-3 py-1.5">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-paper/30"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                          <span class="text-[11px] text-paper/30">Search integrations...</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                          {[
                            { name: 'Slack', color: 'bg-[#4A154B]' },
                            { name: 'GitHub', color: 'bg-[#24292e]' },
                            { name: 'Notion', color: 'bg-paper/20' },
                            { name: 'Sheets', color: 'bg-[#0F9D58]' },
                            { name: 'Discord', color: 'bg-[#5865F2]' },
                            { name: 'Linear', color: 'bg-[#5E6AD2]' },
                            { name: 'Vercel', color: 'bg-paper/20' },
                            { name: 'Stripe', color: 'bg-[#635BFF]' },
                          ].map((app) => (
                            <div class="flex flex-col items-center gap-1.5 rounded-lg bg-paper/[0.04] border border-paper/[0.06] p-2">
                              <div class={`w-8 h-8 rounded-lg ${app.color} flex items-center justify-center text-[10px] font-bold text-paper`}>
                                {app.name.charAt(0)}
                              </div>
                              <span class="text-[10px] text-paper/50">{app.name}</span>
                              <div class="h-1 w-1 rounded-full bg-zen-green"></div>
                            </div>
                          ))}
                        </div>
                        <div class="flex items-center justify-between text-[10px] text-paper/30">
                          <span>500+ platforms available</span>
                          <span class="text-zen-green">8 connected</span>
                        </div>
                      </div>
                    )}

                    {/* Panel 4: Sandboxed Execution */}
                    {i === 4 && (
                      <div class="flex h-full flex-col">
                        <div class="flex items-center gap-3 border-b border-paper/10 px-4 py-2">
                          <span class="rounded bg-zen-green/20 px-2 py-0.5 text-[10px] text-zen-green">Running</span>
                          <span class="text-[10px] text-paper/30 font-mono">sandbox-e2b-7f3a</span>
                        </div>
                        <div class="flex-1 flex flex-col gap-3 p-4 sm:p-5">
                          <div class="grid grid-cols-3 gap-2 text-[10px]">
                            <div class="rounded-lg bg-paper/[0.06] p-2.5">
                              <div class="text-paper/30 mb-1">CPU</div>
                              <div class="text-sm font-semibold text-paper/80">2 vCPU</div>
                              <div class="mt-1.5 h-1 rounded-full bg-paper/10 overflow-hidden"><div class="h-full w-3/5 rounded-full bg-zen-blue"></div></div>
                            </div>
                            <div class="rounded-lg bg-paper/[0.06] p-2.5">
                              <div class="text-paper/30 mb-1">RAM</div>
                              <div class="text-sm font-semibold text-paper/80">4 GB</div>
                              <div class="mt-1.5 h-1 rounded-full bg-paper/10 overflow-hidden"><div class="h-full w-2/5 rounded-full bg-zen-green"></div></div>
                            </div>
                            <div class="rounded-lg bg-paper/[0.06] p-2.5">
                              <div class="text-paper/30 mb-1">Disk</div>
                              <div class="text-sm font-semibold text-paper/80">10 GB</div>
                              <div class="mt-1.5 h-1 rounded-full bg-paper/10 overflow-hidden"><div class="h-full w-1/4 rounded-full bg-coral"></div></div>
                            </div>
                          </div>
                          <div class="flex-1 rounded-lg bg-paper/[0.03] border border-paper/[0.06] p-3 font-mono text-[11px] leading-relaxed text-paper/50 overflow-hidden">
                            <div><span class="text-paper/30">$</span> npm install</div>
                            <div class="text-zen-green">added 247 packages in 3.2s</div>
                            <div><span class="text-paper/30">$</span> npm run test</div>
                            <div class="text-zen-green">&#10003; 24/24 tests passed</div>
                            <div><span class="text-paper/30">$</span> npm run build</div>
                            <div class="text-zen-green">&#10003; Build complete (2.1s)</div>
                            <div class="text-paper/30 mt-1">Isolated. No access to host system.</div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
                </div>
              </div>
            </div>
          ))}
        </div>
        <!-- Mobile description (shown below panel) -->
        <div class="mt-4 lg:hidden">
          {features.map((feature, i) => (
            <p
              class={cn(
                'feature-description text-sm text-dark/60',
                i !== 0 && 'hidden',
              )}
              data-feature-index={i}
            >
              {feature.description}
            </p>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function initFeatures() {
    const tabs = document.querySelectorAll<HTMLButtonElement>('[data-feature-index][role="tab"]');
    const panels = document.querySelectorAll<HTMLDivElement>('.feature-panel[data-feature-index]');
    const descriptions = document.querySelectorAll<HTMLParagraphElement>('.feature-description[data-feature-index]');

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const index = tab.dataset.featureIndex;

        // Update all tabs
        tabs.forEach((t) => {
          const isActive = t.dataset.featureIndex === index;
          t.dataset.active = String(isActive);
          t.setAttribute('aria-selected', String(isActive));
          // Desktop items
          if (t.classList.contains('feature-item')) {
            t.classList.toggle('bg-subtle', isActive);
            t.classList.toggle('opacity-50', !isActive);
            t.classList.toggle('hover:opacity-80', !isActive);
            t.classList.toggle('hover:bg-subtle/50', !isActive);
          }
          // Mobile tabs
          if (t.classList.contains('feature-tab')) {
            t.classList.toggle('bg-subtle', isActive);
            t.classList.toggle('text-dark', isActive);
            t.classList.toggle('text-dark/50', !isActive);
          }
        });

        // Update panels with crossfade
        panels.forEach((panel) => {
          const isActive = panel.dataset.featureIndex === index;
          panel.dataset.active = String(isActive);
          panel.classList.toggle('opacity-0', !isActive);
          panel.classList.toggle('pointer-events-none', !isActive);
          panel.classList.toggle('opacity-100', isActive);
        });

        // Update mobile descriptions
        descriptions.forEach((desc) => {
          desc.classList.toggle('hidden', desc.dataset.featureIndex !== index);
        });
      });
    });
  }

  initFeatures();
  document.addEventListener('astro:after-swap', initFeatures);
</script>
